# Test Plan Execution Report

**Plan:** docs/testing/pr-test-plan.md
**Branch:** feat/279-per-agent-driver-config
**Worktree:** ../amelia-test-run-20260123-060955
**Executed:** 2026-01-23 06:09:55
**Duration:** ~15 minutes

## Summary

| Status | Count |
|--------|-------|
| PASS   | 11    |
| FAIL   | 0     |
| SKIP   | 0     |

## All Results

| Test ID | Name | Status | Notes |
|---------|------|--------|-------|
| TC-01 | First-time setup creates agents dict | PASS | Profile created with 7 agents, all using cli:claude/opus |
| TC-02 | CLI profile list shows agent count | PASS | Table shows Name, Driver, Model, Tracker, Agents columns |
| TC-03 | CLI profile show displays agents table | PASS | Separate "Agent Configurations" table with Agent, Driver, Model, Options |
| TC-04 | API profile create with agents | PASS | POST /api/profiles accepts agents dict, returns correct structure |
| TC-05 | API profile update agents | PASS | PUT /api/profiles/{id} updates agents, changes persist |
| TC-06 | Old database schema warning | PASS | Warning logged about old schema with 'driver' column |
| TC-07 | Dashboard profile list | PASS | Profiles displayed with agent config (ARCH/DEV/REV), driver badges, utility count |
| TC-08 | Profile.get_agent_config method | PASS | Returns AgentConfig for existing agents, raises ValueError for missing |
| TC-09 | Brainstorm uses per-agent config | PASS | Code inspection: brainstorm.py uses profile.get_agent_config("brainstormer") |
| TC-10 | Profile activation is_active status | PASS | Only activated profile has is_active=true |
| TC-11 | Dashboard profile edit | PASS | Edit modal shows agent configs, changes persist to database |

## Test Execution Details

### TC-01: First-Time Setup Creates Profile with Agents Dict

**Command:**
```bash
uv run amelia config profile create default -d cli:claude -m opus -w /Users/ka/github/existential-birds/test_repo_c -t noop -a
```

**Result:**
- Profile created with 7 standard agents: architect, developer, reviewer, task_reviewer, evaluator, brainstormer, plan_validator
- All agents share the same driver (cli:claude) and model (opus)
- `--validator-model` flag removed from CLI (as expected)

### TC-02: CLI Profile List Shows Agent Count

**Command:**
```bash
uv run amelia config profile list
```

**Output:**
```
                     Profiles
┏━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━━┳━━━━━━━━┓
┃ Name    ┃ Driver     ┃ Model ┃ Tracker ┃ Agents ┃
┡━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━━━╇━━━━━━━━┩
│ default │ cli:claude │ opus  │ noop    │ 7      │
└─────────┴────────────┴───────┴─────────┴────────┘
```

### TC-03: CLI Profile Show Displays Agents Table

**Command:**
```bash
uv run amelia config profile show default
```

**Output:**
```
                            Profile: default
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Field                ┃ Value                                          ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ Tracker              │ noop                                           │
│ Working Dir          │ /Users/ka/github/existential-birds/test_repo_c │
│ Plan Output Dir      │ docs/plans                                     │
│ Plan Path Pattern    │ docs/plans/{date}-{issue_key}.md               │
│ Auto Approve Reviews │ False                                          │
└──────────────────────┴────────────────────────────────────────────────┘
              Agent Configurations
┏━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━━┓
┃ Agent          ┃ Driver     ┃ Model ┃ Options ┃
┡━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━━━┩
│ architect      │ cli:claude │ opus  │ -       │
│ developer      │ cli:claude │ opus  │ -       │
│ reviewer       │ cli:claude │ opus  │ -       │
│ task_reviewer  │ cli:claude │ opus  │ -       │
│ evaluator      │ cli:claude │ opus  │ -       │
│ brainstormer   │ cli:claude │ opus  │ -       │
│ plan_validator │ cli:claude │ opus  │ -       │
└────────────────┴────────────┴───────┴─────────┘
```

### TC-04: API Profile Create with Agents

**Request:**
```bash
curl -X POST http://localhost:8420/api/profiles \
  -H "Content-Type: application/json" \
  -d '{
    "id": "mixed-models",
    "tracker": "noop",
    "working_dir": "/Users/ka/github/existential-birds/test_repo_c",
    "agents": {
      "architect": {"driver": "api:openrouter", "model": "opus"},
      "developer": {"driver": "cli:claude", "model": "sonnet"},
      "reviewer": {"driver": "api:openrouter", "model": "haiku"}
    }
  }'
```

**Response:** Profile created with correct agents structure and is_active=false.

### TC-05: API Profile Update Agents

**Request:**
```bash
curl -X PUT http://localhost:8420/api/profiles/mixed-models \
  -H "Content-Type: application/json" \
  -d '{
    "agents": {
      "architect": {"driver": "cli:claude", "model": "opus"},
      "developer": {"driver": "cli:claude", "model": "opus"},
      "reviewer": {"driver": "cli:claude", "model": "opus"}
    }
  }'
```

**Result:** All agents updated to cli:claude/opus.

### TC-06: Old Database Schema Warning

**Setup:**
```bash
sqlite3 ~/.amelia/test-old.db "CREATE TABLE profiles (id TEXT PRIMARY KEY, driver TEXT, model TEXT);"
AMELIA_DATABASE_PATH=~/.amelia/test-old.db uv run amelia server
```

**Log Output:**
```
WARNING │ Database has old schema with 'driver' column in profiles table.
The schema has changed to use per-agent configuration.
Please delete the database file and restart Amelia.
WARNING │ To delete the database, run: rm /Users/ka/.amelia/test-old.db
```

### TC-07: Dashboard Profile List

**Verification:** Dashboard displays profiles with:
- Profile cards showing agent configuration (ARCH, DEV, REV with models)
- CLI:CLAUDE driver badges
- "+4 utility agents" indicator for profiles with utility agents
- Active badge on active profile
- Working directory path

### TC-08: Profile.get_agent_config Method

**Test Code:**
```python
profile = Profile(
    name='test',
    working_dir='/Users/ka/github/existential-birds/test_repo_c',
    agents={'architect': AgentConfig(driver='cli:claude', model='opus')}
)
config = profile.get_agent_config('architect')
# Returns: driver='cli:claude' model='opus' options={}

profile.get_agent_config('developer')
# Raises: ValueError: Agent 'developer' not configured in profile 'test'
```

### TC-09: Brainstorm Uses Per-Agent Config

**Code Verification:** `amelia/server/routes/brainstorm.py:90`
```python
agent_config = profile.get_agent_config("brainstormer")
```

### TC-10: Profile Activation is_active Status

**Verification:**
```bash
curl http://localhost:8420/api/profiles | jq '.[] | {id, is_active}'
```

**Result:**
- profile-a: is_active=True (activated)
- All others: is_active=False

### TC-11: Dashboard Profile Edit

**Verification:**
1. Clicked edit on "default" profile
2. Edit modal displayed with:
   - Quick presets (Maximum Power, Balanced, Cost Efficient)
   - Bulk Configuration option
   - Primary Agents (Architect, Developer, Reviewer) with Driver/Model selects
   - Utility Agents section (collapsed, showing "4 configured")
3. Changed Architect model from "opus" to "sonnet"
4. Clicked "Save Changes"
5. Toast notification: "Profile updated"
6. API verification confirmed change persisted

## Notes

- **Dashboard Build Required:** The test worktree required copying uncommitted dashboard changes and rebuilding with `pnpm build` before UI tests could run.
- **API Endpoint:** The profiles API is at `/api/profiles`, not `/api/settings/profiles` as documented in some test cases.
- **TC-09:** Verified by code inspection since actual brainstorm execution requires LLM calls.

## Environment

- Platform: darwin (macOS)
- Python: 3.13
- Node: pnpm for dashboard build
- Browser: Chrome (via chrome-devtools MCP)
