version: 1
metadata:
  branch: refactor/remove-auto-approve-dead-code-344
  base: main
  generated: "2026-01-25T20:30:00Z"
  changes_summary: |
    Refactor to remove the unused auto_approve_reviews feature from the review workflow.

    Changes:
    - Removed auto_approve_reviews field from Profile model
    - Removed auto_approve flag from ImplementationState
    - Removed review_approval_node and end_approval_node from the review graph
    - Simplified routing logic to always loop: reviewer -> evaluation -> developer
    - Removed Auto-approve toggle from Profile edit modal in dashboard

    The review workflow now runs automatically until max_review_passes is reached
    or no issues remain. This is a simplification that removes dead code.

setup:
  stack:
    - type: python
      package_manager: uv
    - type: node
      package_manager: pnpm
      path: dashboard/
  commands:
    - uv sync
    - cd dashboard && pnpm install
    - uv run amelia dev &
  health_checks:
    - url: http://localhost:8420/api/v1/health
      timeout: 30
    - url: http://localhost:8420
      timeout: 30

tests:
  # Backend API Tests
  - id: TC-01
    name: Profile API no longer returns auto_approve_reviews field
    context: |
      The auto_approve_reviews field was removed from ProfileResponse in
      amelia/server/routes/settings.py. API responses should no longer include
      this field.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/v1/settings/profiles
    expected: |
      Response returns a list of profiles. Each profile object should NOT contain
      an "auto_approve_reviews" field. The response should include other expected
      fields like id, name, driver, model, tracker, working_dir, plan_output_dir,
      plan_path_pattern, agents, and is_active.

  - id: TC-02
    name: Create profile without auto_approve_reviews field
    context: |
      ProfileCreate no longer accepts auto_approve_reviews. Creating a profile
      should work without this field and should not return it in the response.
      Changed files: amelia/server/routes/settings.py, amelia/core/types.py
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/v1/settings/profiles
        headers:
          Content-Type: application/json
        body: |
          {
            "name": "test-no-auto-approve",
            "driver": "api:openai",
            "model": "gpt-4o-mini",
            "tracker": "none",
            "working_dir": "/Users/ka/github/existential-birds/test_repo_c",
            "agents": {
              "architect": {"driver": "api:openai", "model": "gpt-4o-mini"},
              "developer": {"driver": "api:openai", "model": "gpt-4o-mini"},
              "reviewer": {"driver": "api:openai", "model": "gpt-4o-mini"}
            }
          }
    expected: |
      Profile is created successfully with HTTP 201. Response body contains the
      profile data WITHOUT auto_approve_reviews field. All other fields are
      present and match the request.

  - id: TC-03
    name: Update profile does not accept auto_approve_reviews
    context: |
      ProfileUpdate no longer accepts auto_approve_reviews. Updating a profile
      should work without this field.
      Changed files: amelia/server/routes/settings.py
    steps:
      - action: curl
        method: PUT
        url: http://localhost:8420/api/v1/settings/profiles/${TEST_PROFILE_ID}
        headers:
          Content-Type: application/json
        body: |
          {
            "working_dir": "/Users/ka/github/existential-birds/test_repo_c"
          }
    expected: |
      Profile is updated successfully with HTTP 200. Response shows updated
      working_dir. Response does NOT contain auto_approve_reviews field.

  # Dashboard UI Tests
  - id: TC-04
    name: Profile edit modal does not show Auto-approve toggle
    context: |
      The ToggleField for "Auto-approve Reviews" was removed from
      dashboard/src/components/settings/ProfileEditModal.tsx. The toggle
      should no longer appear in the profile edit form.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/settings/profiles
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@edit-button-first-profile"
        note: Click the edit button for the first profile in the list
      - action: agent-browser wait
        type: element
        value: "Profile modal is open"
      - action: agent-browser snapshot
    expected: |
      The profile edit modal opens. The form should show fields for:
      - Profile name
      - Driver selection
      - Model selection
      - Tracker selection
      - Working directory
      - Plan output directory
      - Plan path pattern
      - Agent configurations (expandable sections)
      - Advanced settings (expandable)

      The form should NOT contain:
      - "Auto-approve Reviews" toggle
      - "auto_approve" checkbox
      - Any reference to automatic approval
    evidence:
      screenshot: evidence/tc-04-profile-modal.png

  - id: TC-05
    name: Create new profile without auto-approve option
    context: |
      When creating a new profile through the dashboard, the auto-approve
      option should not be visible. The form should save successfully without
      any auto-approve setting.
      Changed files: dashboard/src/components/settings/ProfileEditModal.tsx
    steps:
      - action: agent-browser open
        url: http://localhost:8420/settings/profiles
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@new-profile-button"
        note: Click "New Profile" or "+" button to create a new profile
      - action: agent-browser wait
        type: element
        value: "Profile modal is open"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@profile-name-input"
        value: "Test Profile No Auto"
      - action: agent-browser fill
        ref: "@working-dir-input"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser snapshot
    expected: |
      The new profile form appears with all required fields.
      No "Auto-approve Reviews" toggle is present anywhere in the form.
      The form fields can be filled out successfully.
    evidence:
      screenshot: evidence/tc-05-new-profile-form.png

  # Review Workflow Integration Test
  - id: TC-06
    name: Review workflow runs without approval nodes
    context: |
      The review workflow graph was simplified to remove review_approval_node
      and end_approval_node. The workflow should now run continuously from
      reviewer -> evaluation -> developer until max passes or completion.
      Changed files: amelia/pipelines/review/graph.py, nodes.py, routing.py
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/v1/workflows/review
        headers:
          Content-Type: application/json
        body: |
          {
            "profile_name": "default"
          }
    expected: |
      The review workflow starts successfully (HTTP 201).
      Response includes workflow_id.

      Note: This test verifies the workflow can be created. Full workflow
      execution testing requires an actual code change to review, which
      should be done manually by running 'amelia review --local' with
      local changes present.

  - id: TC-07
    name: Health check confirms server running
    context: |
      Basic health check to ensure the server starts correctly after the
      refactoring changes.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/v1/health
    expected: |
      Response returns HTTP 200 with status "healthy".
      All services should report as available.

cleanup:
  commands:
    - |
      # Delete test profile if created
      curl -X DELETE http://localhost:8420/api/v1/settings/profiles/test-no-auto-approve 2>/dev/null || true
