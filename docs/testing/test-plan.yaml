version: 1
metadata:
  branch: feat/346-plan-import-ui
  base: main
  generated: "2026-01-25T00:00:00Z"
  changes_summary: |
    Adds file preview capability to PlanImportSection, a reusable component for
    importing external plans into workflows. The component now supports reading
    external plan files via the server API when a worktreePath is provided, showing
    a preview of the plan (goal, task count, key files). Both QuickShotModal and
    SetPlanModal have been updated to pass worktreePath to PlanImportSection.
    Additional fixes include skipping the initial onPlanChange callback and
    deduplicating error toasts.

    Changed files:
    - dashboard/src/components/PlanImportSection.tsx (file preview feature)
    - dashboard/src/components/QuickShotModal.tsx (pass worktreePath)
    - dashboard/src/components/SetPlanModal.tsx (wire worktreePath, enhance success toast)
    - dashboard/src/components/__tests__/PlanImportSection.test.tsx
    - dashboard/src/components/__tests__/QuickShotModal.test.tsx
    - dashboard/src/components/__tests__/SetPlanModal.test.tsx

setup:
  stack:
    - type: python
      package_manager: uv
      role: backend API server
    - type: node
      package_manager: pnpm
      role: frontend dashboard
  test_repo: /Users/ka/github/existential-birds/test_repo_c
  commands:
    - uv sync
    - cd dashboard && pnpm install
    # Create a sample plan file in the test repo for file-preview tests
    - |
      mkdir -p /Users/ka/github/existential-birds/test_repo_c
      cat > /Users/ka/github/existential-birds/test_repo_c/plan.md << 'PLAN_EOF'
      # Goal
      Refactor data pipeline for performance

      ## Tasks
      - [ ] Profile slow queries
      - [ ] Add database indexes
      - [ ] Implement caching layer
      - [ ] Write benchmark tests
      - [ ] Update monitoring dashboards

      ## Key Files
      - src/pipeline.py
      - src/cache.py
      - tests/test_benchmark.py
      PLAN_EOF
    # Build dashboard to ensure static files are up to date
    - cd dashboard && pnpm build
    # CRITICAL: Free port 8420 before starting the dev server.
    # Another amelia instance (e.g. from a sibling repo) may already be
    # listening, which causes `amelia dev` to silently fail to bind.
    # After starting, verify OUR process owns the port.
    - |
      existing_pid=$(lsof -ti :8420 2>/dev/null)
      if [ -n "$existing_pid" ]; then
        echo "⚠ Port 8420 occupied by PID $existing_pid — killing it"
        kill $existing_pid 2>/dev/null
        sleep 2
      fi
    - uv run amelia dev
  post_start_verification:
    description: |
      After starting the dev server and before health checks, confirm that
      the correct process is listening on port 8420. This catches the silent-
      failure scenario where another server occupied the port.
    steps:
      - action: shell
        command: |
          # Verify the server PID file process is actually listening
          server_pid=$(cat .beagle/dev-server.pid 2>/dev/null)
          listening_pid=$(lsof -ti :8420 2>/dev/null | head -1)
          if [ -z "$listening_pid" ]; then
            echo "✗ No process listening on port 8420"
            exit 1
          fi
          echo "✓ Port 8420 owned by PID $listening_pid"
        description: "Verify our amelia dev process actually bound to port 8420"
      - action: shell
        command: |
          # Verify the served HTML references a JS bundle that exists on disk
          served_bundle=$(curl -s http://localhost:8420/ | grep -oE 'index-[A-Za-z0-9]+\.js' | head -1)
          if [ -z "$served_bundle" ]; then
            echo "✗ Could not extract JS bundle name from served HTML"
            exit 1
          fi
          if [ ! -f "amelia/server/static/assets/$served_bundle" ]; then
            echo "✗ Served bundle '$served_bundle' not found on disk — stale server?"
            echo "  On-disk bundles:"
            ls amelia/server/static/assets/index-*.js 2>/dev/null
            exit 1
          fi
          echo "✓ Served bundle '$served_bundle' matches on-disk file"
        description: "Verify served JS bundle matches the built assets (catches stale server)"
  health_checks:
    - url: http://localhost:8420/api/health
      timeout: 30
    - url: http://localhost:8420
      timeout: 30
  # After health checks pass, ensure a profile exists and is active.
  # The server requires an active profile for workflow creation.
  profile_setup:
    description: |
      Check for existing profiles via GET /api/profiles. If the list is empty,
      create a test profile and activate it. This ensures workflows can be created
      during the test run.
    steps:
      - action: curl
        method: GET
        url: http://localhost:8420/api/profiles
        description: "List existing profiles; if non-empty, skip creation"
      - action: curl
        method: POST
        url: http://localhost:8420/api/profiles
        headers:
          Content-Type: application/json
        body: |
          {
            "id": "test",
            "tracker": "noop",
            "working_dir": "/Users/ka/github/existential-birds/test_repo_c",
            "plan_output_dir": "docs/plans",
            "plan_path_pattern": "docs/plans/{date}-{issue_key}.md",
            "agents": {
              "architect": {
                "driver": "api",
                "model": "claude-sonnet-4-20250514",
                "options": {}
              },
              "developer": {
                "driver": "cli",
                "model": "claude-sonnet-4-20250514",
                "options": {"max_iterations": 3}
              },
              "reviewer": {
                "driver": "api",
                "model": "claude-sonnet-4-20250514",
                "options": {}
              }
            }
          }
        description: "Create test profile (skip if profiles already exist)"
      - action: curl
        method: POST
        url: http://localhost:8420/api/profiles/test/activate
        description: "Activate the test profile (skip if another profile is already active)"

tests:
  # ── PlanImportSection: File mode with preview ──────────────────────────
  - id: TC-01
    name: "PlanImportSection file mode shows preview when file path entered"
    context: |
      PlanImportSection.tsx gained a file preview feature: when worktreePath is
      provided, entering a relative file path and clicking the eye/preview button
      fetches the file content via POST /api/files/read and displays a parsed
      preview (goal, task count, key files). This is the core new functionality.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@quick-shot-button"
        description: "Click the 'Quick Shot' button in the sidebar under TOOLS"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@task-id"
        value: "test-plan-preview"
      - action: agent-browser fill
        ref: "@worktree-path"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser fill
        ref: "@task-title"
        value: "Test Plan Preview"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@external-plan-toggle"
        description: "Expand the External Plan section"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@plan-file-input"
        value: "plan.md"
        description: "Enter a relative file path for the plan (exists in test repo)"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@preview-button"
        description: "Click the eye icon to preview the file"
      - action: agent-browser snapshot
    expected: |
      The Quick Shot modal opens. After expanding the External Plan section and
      entering "plan.md", a preview button (eye icon) is visible. Clicking it
      reads the file via POST /api/files/read. Since plan.md exists in the test
      repo, a preview appears showing goal ("Refactor data pipeline for
      performance"), task count (5 tasks), and key files (src/pipeline.py,
      src/cache.py, tests/test_benchmark.py).
    evidence:
      screenshot: evidence/tc-01.png

  # ── PlanImportSection: Paste mode with preview ─────────────────────────
  - id: TC-02
    name: "PlanImportSection paste mode shows inline preview"
    context: |
      The paste mode of PlanImportSection parses markdown content locally and
      shows a preview. This verifies the existing paste mode still works correctly
      alongside the new file mode changes.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@quick-shot-button"
        description: "Click the 'Quick Shot' button in the sidebar"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@task-id"
        value: "test-paste-plan"
      - action: agent-browser fill
        ref: "@worktree-path"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser fill
        ref: "@task-title"
        value: "Test Paste Preview"
      - action: agent-browser click
        ref: "@external-plan-toggle"
        description: "Expand the External Plan section"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@paste-mode-tab"
        description: "Switch to Paste mode"
      - action: agent-browser fill
        ref: "@plan-textarea"
        value: |
          # Goal
          Implement user authentication

          ## Tasks
          - [ ] Add login endpoint
          - [ ] Add signup endpoint
          - [ ] Add JWT middleware

          ## Key Files
          - src/auth.ts
          - src/middleware.ts
      - action: agent-browser snapshot
    expected: |
      After switching to Paste mode and entering markdown content, a preview
      appears showing the extracted goal ("Implement user authentication"),
      task count (3 tasks), and key files (src/auth.ts, src/middleware.ts).
    evidence:
      screenshot: evidence/tc-02.png

  # ── QuickShotModal: worktreePath passed to PlanImportSection ───────────
  - id: TC-03
    name: "QuickShotModal passes worktreePath to PlanImportSection for file preview"
    context: |
      QuickShotModal.tsx was updated to pass the worktree_path form field value
      to PlanImportSection as worktreePath. This enables the file preview button
      to appear and function when a worktree path is filled in.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@quick-shot-button"
        description: "Click the 'Quick Shot' button"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@worktree-path"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser click
        ref: "@external-plan-toggle"
        description: "Expand External Plan section"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@plan-file-input"
        value: "plan.md"
      - action: agent-browser snapshot
    expected: |
      After entering the worktree path and expanding the External Plan section,
      the file input is available with a preview button (eye icon). The preview
      button should be visible because worktreePath is provided from the form.
      Without a worktree path, the preview button should not appear.
    evidence:
      screenshot: evidence/tc-03.png

  # ── QuickShotModal: Plan & Queue disabled with external plan ───────────
  - id: TC-04
    name: "QuickShotModal disables Plan & Queue when external plan is provided"
    context: |
      When a user provides an external plan (via file or paste), the "Plan & Queue"
      action should be disabled since planning is unnecessary with a pre-existing
      plan. This tests the interaction between PlanImportSection and modal actions.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@quick-shot-button"
      - action: agent-browser fill
        ref: "@task-id"
        value: "test-plan-disable"
      - action: agent-browser fill
        ref: "@worktree-path"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser fill
        ref: "@task-title"
        value: "Test Disable Plan"
      - action: agent-browser click
        ref: "@external-plan-toggle"
      - action: agent-browser click
        ref: "@paste-mode-tab"
      - action: agent-browser fill
        ref: "@plan-textarea"
        value: "# Goal\nTest plan content\n## Tasks\n- [ ] Task one"
      - action: agent-browser snapshot
    expected: |
      After entering plan content, the "Plan & Queue" button becomes disabled
      (grayed out or not clickable) because an external plan is already provided.
      The "Queue" and "Start" buttons should remain enabled.
    evidence:
      screenshot: evidence/tc-04.png

  # ── SetPlanModal: Set plan on a pending workflow ───────────────────────
  - id: TC-05
    name: "SetPlanModal applies plan to pending workflow with enhanced success toast"
    context: |
      SetPlanModal.tsx was updated to wire worktreePath to PlanImportSection and
      show an enhanced success toast with task count ("Plan applied: N tasks").
      This tests the full flow of setting a plan on an already-queued workflow.
    precondition: |
      A workflow must exist in 'pending' (queued) status. The setup curl step
      below creates one using the test repo as the worktree path.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/workflows
        headers:
          Content-Type: application/json
        body: |
          {
            "issue_id": "test-set-plan",
            "worktree_path": "/Users/ka/github/existential-birds/test_repo_c",
            "task_title": "Test Set Plan",
            "start": false,
            "plan_now": false
          }
        description: "Create a pending workflow first"
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@test-set-plan-workflow"
        description: "Click on the pending workflow to view details"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@set-plan-button"
        description: "Click the 'Set Plan' button in PendingWorkflowControls"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@paste-mode-tab"
        description: "Switch to Paste mode in PlanImportSection"
      - action: agent-browser fill
        ref: "@plan-textarea"
        value: |
          # Goal
          Implement feature X

          ## Tasks
          - [ ] Create data model
          - [ ] Build API endpoint
          - [ ] Add tests
          - [ ] Update documentation

          ## Key Files
          - src/models.py
          - src/routes.py
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@apply-button"
        description: "Click Apply to set the plan"
      - action: agent-browser snapshot
    expected: |
      The SetPlanModal opens with PlanImportSection already expanded. After
      pasting plan content and clicking Apply, the plan is applied via
      POST /api/workflows/{id}/plan. A success toast appears showing the task
      count (e.g., "Plan applied: 4 tasks"). The modal closes and the workflow
      detail view refreshes to show the plan is set.
    evidence:
      screenshot: evidence/tc-05.png

  # ── SetPlanModal: File mode with preview in SetPlanModal ───────────────
  - id: TC-06
    name: "SetPlanModal supports file preview via worktreePath"
    context: |
      SetPlanModal now passes its worktreePath prop to PlanImportSection,
      enabling file preview. This verifies the wiring works in the SetPlanModal
      context (not just QuickShotModal).
    precondition: |
      A workflow must exist in 'pending' status with worktree_path set to
      /Users/ka/github/existential-birds/test_repo_c. Reuse the workflow
      created in TC-05, or create a new one.
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@pending-workflow"
        description: "Click on a pending workflow"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@set-plan-button"
        description: "Click 'Set Plan'"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@plan-file-input"
        value: "plan.md"
        description: "Enter a file path (plan.md exists in test repo)"
      - action: agent-browser snapshot
    expected: |
      The SetPlanModal opens with PlanImportSection expanded in file mode.
      A preview button (eye icon) is visible because worktreePath is passed.
      Entering "plan.md" and clicking preview reads the file from the test repo.
      The preview button is functional and accessible.
    evidence:
      screenshot: evidence/tc-06.png

  # ── Error handling: skip initial onPlanChange, deduplicate toasts ──────
  - id: TC-07
    name: "PlanImportSection skips initial onPlanChange and deduplicates error toasts"
    context: |
      Fix in fe3573e9: PlanImportSection now skips the initial onPlanChange
      callback to avoid triggering unnecessary parent state updates on mount.
      Error toasts are also deduplicated to prevent multiple identical toasts
      from appearing (e.g., when file read fails repeatedly).
    steps:
      - action: agent-browser open
        url: http://localhost:8420/workflows
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@quick-shot-button"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@external-plan-toggle"
        description: "Expand External Plan - should not trigger parent state update"
      - action: agent-browser snapshot
      - action: agent-browser fill
        ref: "@worktree-path"
        value: "/Users/ka/github/existential-birds/test_repo_c"
      - action: agent-browser fill
        ref: "@plan-file-input"
        value: "nonexistent.md"
      - action: agent-browser click
        ref: "@preview-button"
        description: "Click preview for nonexistent file"
      - action: agent-browser snapshot
      - action: agent-browser click
        ref: "@preview-button"
        description: "Click preview again - should not create duplicate toast"
      - action: agent-browser snapshot
    expected: |
      When PlanImportSection first expands, no spurious state update or toast
      occurs (the initial onPlanChange is skipped). When previewing a nonexistent
      file, an error message appears inline. Clicking preview again for the same
      error does not create a duplicate error toast - only one error indication
      is shown at a time.
    evidence:
      screenshot: evidence/tc-07.png

  # ── API: POST /api/files/read endpoint ─────────────────────────────────
  - id: TC-08
    name: "API: /api/files/read returns file content for valid path"
    context: |
      The file preview feature depends on POST /api/files/read. This verifies
      the backend endpoint works correctly for both success and error cases.
      Uses plan.md created in the test repo during setup.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/files/read
        headers:
          Content-Type: application/json
        body: |
          {
            "path": "/Users/ka/github/existential-birds/test_repo_c/plan.md"
          }
        description: "Read a valid file from the test repo"
      - action: curl
        method: POST
        url: http://localhost:8420/api/files/read
        headers:
          Content-Type: application/json
        body: |
          {
            "path": "/Users/ka/github/existential-birds/test_repo_c/nonexistent-file.md"
          }
        description: "Try reading a nonexistent file"
      - action: curl
        method: POST
        url: http://localhost:8420/api/files/read
        headers:
          Content-Type: application/json
        body: |
          {
            "path": "../../../etc/passwd"
          }
        description: "Try path traversal (should be rejected)"
    expected: |
      1. Valid file: Returns 200 with the plan.md content (goal, tasks, key files)
      2. Nonexistent file: Returns 404 with error message
      3. Path traversal: Returns 400/422 with validation error (invalid path)
    evidence: {}

  # ── API: POST /api/workflows/{id}/plan endpoint ────────────────────────
  - id: TC-09
    name: "API: /api/workflows/{id}/plan sets plan on pending workflow"
    context: |
      SetPlanModal calls POST /api/workflows/{id}/plan. The enhanced success
      toast now shows total_tasks from the response. This verifies the API
      returns the expected SetPlanResponse shape.
    precondition: |
      Create a pending workflow first via POST /api/workflows.
    steps:
      - action: curl
        method: POST
        url: http://localhost:8420/api/workflows
        headers:
          Content-Type: application/json
        body: |
          {
            "issue_id": "test-api-plan",
            "worktree_path": "/Users/ka/github/existential-birds/test_repo_c",
            "task_title": "Test API Plan",
            "start": false,
            "plan_now": false
          }
        description: "Create pending workflow"
      - action: curl
        method: POST
        url: http://localhost:8420/api/workflows/${WORKFLOW_ID}/plan
        headers:
          Content-Type: application/json
        body: |
          {
            "plan_content": "# Goal\nBuild feature\n## Tasks\n- [ ] Task A\n- [ ] Task B\n- [ ] Task C"
          }
        description: "Set plan via plan_content"
    expected: |
      The create workflow call returns a workflow ID. Setting the plan returns
      a SetPlanResponse with { goal: string, key_files: string[], total_tasks: number }.
      The total_tasks field should be 3 (matching the 3 tasks in the content).
      The goal should be "Build feature".
    evidence: {}
